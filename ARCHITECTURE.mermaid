```mermaid
flowchart TD
    subgraph Input["Input Data"]
        A[Sample Unit Definition<br/>area, location] 
        B[Distress Observations<br/>type, severity, quantity]
    end

    subgraph DensityCalc["Step 1: Density Calculation"]
        C{Distress<br/>Unit Type?}
        D[Area-based<br/>density = area/sample_area × 100]
        E[Linear<br/>density = length/sample_area × 100]
        F[Count<br/>density = count/sample_area × 100]
    end

    subgraph DeductLookup["Step 2: Deduct Value Lookup"]
        G[Select Curve<br/>by distress type + severity]
        H[(Deduct Value<br/>Curves<br/>~57 curves)]
        I[Interpolate<br/>density → deduct value]
        J[List of Deduct Values<br/>DV₁, DV₂, ... DVₙ]
    end

    subgraph CDVCalc["Step 3: CDV Iteration"]
        K[Sort DVs descending<br/>Count q = DVs > 2.0]
        L[Calculate TDV = Σ DVs]
        M[Lookup CDV<br/>from q-curve]
        N[(CDV Curves<br/>q = 1 to 7)]
        O{q > 1?}
        P[Replace lowest DV > 2<br/>with 2.0]
        Q[Decrement q]
        R[Store CDV]
        S[max CDV from<br/>all iterations]
    end

    subgraph Output["Step 4: Final PCI"]
        T[PCI = 100 - max CDV]
        U{PCI Rating}
        V[Good: 85-100]
        W[Satisfactory: 70-85]
        X[Fair: 55-70]
        Y[Poor: 40-55]
        Z[Very Poor: 25-40]
        AA[Serious: 10-25]
        AB[Failed: 0-10]
    end

    A --> C
    B --> C
    C -->|sq ft| D
    C -->|linear ft| E
    C -->|count| F
    D --> G
    E --> G
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    M --> N
    N --> R
    R --> O
    O -->|Yes| P
    P --> Q
    Q --> L
    O -->|No| S
    S --> T
    T --> U
    U --> V
    U --> W
    U --> X
    U --> Y
    U --> Z
    U --> AA
    U --> AB

    style Input fill:#e1f5fe
    style DensityCalc fill:#fff3e0
    style DeductLookup fill:#f3e5f5
    style CDVCalc fill:#e8f5e9
    style Output fill:#fce4ec
```

## Class Diagram

```mermaid
classDiagram
    class DistressType {
        +int id
        +str name
        +str unit  // "area", "linear", "count"
        +bool has_severity
        +get_density(quantity, sample_area) float
    }

    class DistressObservation {
        +DistressType distress_type
        +Severity severity  // L, M, H, or None
        +float quantity
        +float density
        +float deduct_value
    }

    class DeductCurve {
        +int distress_id
        +Severity severity
        +List~Tuple~ points  // (density, deduct_value)
        +interpolate(density) float
    }

    class CDVCurve {
        +int q_value
        +List~Tuple~ points  // (tdv, cdv)
        +interpolate(tdv) float
    }

    class SampleUnit {
        +str id
        +float area
        +List~DistressObservation~ observations
        +calculate_pci() float
    }

    class PCICalculator {
        +Dict deduct_curves
        +Dict cdv_curves
        +get_deduct_value(distress_id, severity, density) float
        +get_cdv(tdv, q) float
        +calculate_sample_pci(observations, sample_area) float
        +calculate_section_pci(sample_units) float
    }

    class PavementSection {
        +str id
        +float total_area
        +List~SampleUnit~ sample_units
        +float pci
        +str rating
    }

    DistressType "1" -- "*" DistressObservation
    DeductCurve "1" -- "1" DistressType
    SampleUnit "1" -- "*" DistressObservation
    PavementSection "1" -- "*" SampleUnit
    PCICalculator "1" -- "*" DeductCurve
    PCICalculator "1" -- "*" CDVCurve
    PCICalculator ..> SampleUnit : calculates
    PCICalculator ..> PavementSection : calculates
```

## Sequence Diagram: PCI Calculation

```mermaid
sequenceDiagram
    participant User
    participant Calculator as PCICalculator
    participant Curves as DeductCurves
    participant CDV as CDVCurves

    User->>Calculator: calculate_pci(sample_unit)
    
    loop For each distress observation
        Calculator->>Calculator: calculate_density()
        Calculator->>Curves: get_deduct_value(type, severity, density)
        Curves-->>Calculator: deduct_value
    end

    Calculator->>Calculator: sort DVs, count q
    
    loop While q >= 1
        Calculator->>Calculator: TDV = sum(DVs)
        Calculator->>CDV: get_cdv(TDV, q)
        CDV-->>Calculator: cdv
        Calculator->>Calculator: store cdv
        Calculator->>Calculator: replace lowest DV>2 with 2
        Calculator->>Calculator: q = q - 1
    end

    Calculator->>Calculator: PCI = 100 - max(cdvs)
    Calculator-->>User: PCI value + rating
```

## State Diagram: CDV Iteration

```mermaid
stateDiagram-v2
    [*] --> Initialize: DVs from all distresses
    
    Initialize --> CountQ: Sort DVs descending
    
    CountQ --> CalculateTDV: q = count(DV > 2)
    
    CalculateTDV --> LookupCDV: TDV = Σ DVs
    
    LookupCDV --> StoreCDV: CDV = f(TDV, q)
    
    StoreCDV --> CheckQ: Store CDV value
    
    CheckQ --> ReduceLowest: q > 1
    CheckQ --> FindMax: q = 1
    
    ReduceLowest --> DecrementQ: Set lowest DV>2 to 2.0
    
    DecrementQ --> CalculateTDV: q = q - 1
    
    FindMax --> [*]: Return max(all CDVs)
```
